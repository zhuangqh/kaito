name: Chart Upgrade Compatibility Test

on:
  pull_request:
    paths:
      - 'charts/**'
  workflow_dispatch:
    inputs:
      old_chart_version:
        description: "Old chart version to upgrade from"
        required: true
        default: "0.7.1"
        type: string

permissions:
  id-token: write
  contents: read

env:
  KIND_VERSION: "0.29.0"
  KUBECTL_VERSION: "1.33.0"
  OLD_CHART_VERSION: ${{ github.event.inputs.old_chart_version || '0.7.1' }}

jobs:
  chart-upgrade-test:
    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install kind
        run: |
          curl -Lo ./kind "https://github.com/kubernetes-sigs/kind/releases/download/v${{ env.KIND_VERSION }}/kind-linux-amd64"
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Install Helm
        uses: azure/setup-helm@b9e51907a09c216f16ebe8536097933489208112 # v4.3.0
        with:
          version: 'v3.19.4'

      - name: Create kind cluster
        run: |
          cat << EOF > kind-config.yaml
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          name: kaito
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: InitConfiguration
              nodeRegistration:
                kubeletExtraArgs:
                  node-labels: "apps=aikit-test"
          EOF
          kind create cluster --config kind-config.yaml
          kubectl cluster-info

      - name: Build workspace controller
        run: |
          # Use the docker-build-workspace target with local configuration
          make docker-build-workspace

          # Load into kind cluster
          kind load docker-image local/workspace:test --name kaito
        env:
          REGISTRY: "local"
          IMG_NAME: "workspace"
          IMG_TAG: "test"
          OUTPUT_TYPE: "type=docker"
          ARCH: "amd64"

      - name: Install old chart (${{ env.OLD_CHART_VERSION }})
        shell: bash
        run: |
          helm repo add kaito https://kaito-project.github.io/kaito/charts/kaito
          helm repo update
          helm install kaito-workspace kaito/workspace --version ${{ env.OLD_CHART_VERSION }} --namespace kaito-workspace --create-namespace
          
          # Wait for deployment to be available
          kubectl wait --for=condition=available deploy "kaito-workspace" -n kaito-workspace --timeout=300s

      - name: Upgrade to current chart
        shell: bash
        run: |
          # Update the Helm values with our local image
          yq -i '(.image.repository) = "local/workspace"' ./charts/kaito/workspace/values.yaml
          yq -i '(.image.tag) = "test"' ./charts/kaito/workspace/values.yaml

          # Upgrade the chart
          helm upgrade kaito-workspace ./charts/kaito/workspace --namespace kaito-workspace

          # Wait for deployment to be rolled out
          kubectl rollout status deploy/kaito-workspace -n kaito-workspace --timeout=300s

      - name: Cleanup
        if: always()
        shell: bash
        run: |
          az group delete --name ${{ env.CLUSTER_NAME }} --yes --no-wait || true
