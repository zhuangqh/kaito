"use strict";(self.webpackChunkkaito_website=self.webpackChunkkaito_website||[]).push([[4891],{8074:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"gateway-api-inference-extension","title":"Gateway API Inference Extension","description":"KAITO integrates with Gateway API Inference Extension (GWIE) to provide model-aware routing and optimal endpoint selection for inference. This page covers what it is, prerequisites, how to enable it in KAITO, how it\u2019s wired, and a quickstart.","source":"@site/docs/gateway-api-inference-extension.md","sourceDirName":".","slug":"/gateway-api-inference-extension","permalink":"/kaito/docs/next/gateway-api-inference-extension","draft":false,"unlisted":false,"editUrl":"https://github.com/kaito-project/kaito/tree/main/website/docs/gateway-api-inference-extension.md","tags":[],"version":"current","frontMatter":{"title":"Gateway API Inference Extension"},"sidebar":"sidebar","previous":{"title":"AIKit Integration with KAITO","permalink":"/kaito/docs/next/aikit"},"next":{"title":"Monitoring","permalink":"/kaito/docs/next/monitoring"}}');var i=t(4848),s=t(8453);const o={title:"Gateway API Inference Extension"},r=void 0,l={},c=[{value:"What is it",id:"what-is-it",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Enable in KAITO",id:"enable-in-kaito",level:2},{value:"How KAITO wires it",id:"how-kaito-wires-it",level:2},{value:"Quickstart",id:"quickstart",level:2},{value:"1. Install Istio and Deploy Gateway",id:"1-install-istio-and-deploy-gateway",level:3},{value:"2. Deploy KAITO Workspace",id:"2-deploy-kaito-workspace",level:3},{value:"3. Deploy DestinationRule and HTTPRoute",id:"3-deploy-destinationrule-and-httproute",level:3},{value:"4. Test Inference",id:"4-test-inference",level:3},{value:"4. [Optional] Deploy BBR",id:"4-optional-deploy-bbr",level:3}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["KAITO integrates with ",(0,i.jsx)(n.a,{href:"https://gateway-api-inference-extension.sigs.k8s.io/",children:"Gateway API Inference Extension"})," (GWIE) to provide model-aware routing and optimal endpoint selection for inference. This page covers what it is, prerequisites, how to enable it in KAITO, how it\u2019s wired, and a quickstart."]}),"\n",(0,i.jsx)(n.h2,{id:"what-is-it",children:"What is it"}),"\n",(0,i.jsxs)(n.p,{children:["Gateway API Inference Extension extends ",(0,i.jsx)(n.a,{href:"https://gateway-api.sigs.k8s.io/",children:"Gateway API"})," with inference-focused backends and behaviors. It adds:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://gateway-api-inference-extension.sigs.k8s.io/api-types/inferencepool/",children:"InferencePool"})," CRD to represent model-serving backends"]}),"\n",(0,i.jsxs)(n.li,{children:["A reference ",(0,i.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/gateway-api-inference-extension/tree/main/pkg/epp",children:"Endpoint Picker"})," (EPP) that uses inference server metrics and policies to pick the best backend"]}),"\n",(0,i.jsxs)(n.li,{children:["Optional ",(0,i.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/gateway-api-inference-extension/tree/main/pkg/bbr",children:"Body-Based Routing"})," (BBR) that extracts model names from OpenAI-style requests and injects a header for routing purposes"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"KAITO uses GWIE to route requests for models to the right Workspace pods, improving latency and GPU utilization."}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.p,{children:"Before enabling this feature in KAITO, ensure the following are installed in your cluster:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["A Gateway API implementation that supports Envoy ext_proc and the Inference Extension pattern. See available Gateway implementations: ",(0,i.jsx)(n.a,{href:"https://gateway-api-inference-extension.sigs.k8s.io/implementations/gateways/",children:"https://gateway-api-inference-extension.sigs.k8s.io/implementations/gateways/"})]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"enable-in-kaito",children:"Enable in KAITO"}),"\n",(0,i.jsx)(n.p,{children:"The feature is off by default. Enable it by setting the workspace chart feature gate:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Based on https://kaito-project.github.io/kaito/docs/installation\nhelm upgrade --install kaito-workspace \\\n  https://github.com/kaito-project/kaito/raw/gh-pages/charts/kaito/workspace-$KAITO_WORKSPACE_VERSION.tgz \\\n  --namespace kaito-workspace \\\n  --create-namespace \\\n  --set featureGates.gatewayAPIInferenceExtension=true \\\n  --wait\n"})}),"\n",(0,i.jsx)(n.h2,{id:"how-kaito-wires-it",children:"How KAITO wires it"}),"\n",(0,i.jsxs)(n.p,{children:["When the feature gate is enabled, ",(0,i.jsx)(n.a,{href:"https://fluxcd.io/",children:"Flux"})," will be installed in the same namespace as the Workspace controller as a Helm dependency. It is used to deploy and manage the GWIE InferencePool Helm chart for each Workspace."]}),"\n",(0,i.jsx)(n.p,{children:"When you create a Workspace, the KAITO Workspace controller will:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Dry-run the inference workload to determine whether it\u2019s a Deployment or StatefulSet (important for how endpoints are selected)"}),"\n",(0,i.jsxs)(n.li,{children:["Create or update two Flux resources in the Workspace namespace:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://fluxcd.io/flux/components/source/ocirepositories/",children:"OCIRepository"}),": points to the upstream GWIE inferencepool Helm chart","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"URL: oci://registry.k8s.io/gateway-api-inference-extension/charts/inferencepool"}),"\n",(0,i.jsxs)(n.li,{children:["Tag/Version: ",(0,i.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/gateway-api-inference-extension/releases/latest",children:"https://github.com/kubernetes-sigs/gateway-api-inference-extension/releases/latest"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://fluxcd.io/flux/components/helm/helmreleases/",children:"HelmRelease"}),": references the OCIRepository and applies values to deploy EPP and related resources"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Wait for Flux resources to become Ready"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"You can inspect these resources with kubectl in the Workspace namespace. Updates to the Workspace will reconcile these resources."}),"\n",(0,i.jsx)(n.h2,{id:"quickstart",children:"Quickstart"}),"\n",(0,i.jsx)(n.p,{children:"In this quickstart example, we will use Istio as the Gateway API provider to handle traffic management and routing, and deploy KAITO Workspaces to serve inference models. The following steps demonstrate how to set up an end-to-end inference gateway that routes requests to model-serving backends managed by KAITO."}),"\n",(0,i.jsx)(n.h3,{id:"1-install-istio-and-deploy-gateway",children:"1. Install Istio and Deploy Gateway"}),"\n",(0,i.jsx)(n.p,{children:"First, install Istio base and control plane components, setting flags that enable Gateway API Inference Extension support in the data plane and pilot:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'TAG=1.28-alpha.89f30b26ba71bf5e538083a4720d0bc2d8c06401\nHUB=gcr.io/istio-testing\nhelm upgrade -i istio-base oci://$HUB/charts/base --version $TAG -n istio-system --create-namespace\nhelm upgrade -i istiod oci://$HUB/charts/istiod \\\n  --version $TAG \\\n  -n istio-system \\\n  --set meshConfig.defaultConfig.proxyMetadata.ENABLE_GATEWAY_API_INFERENCE_EXTENSION="true" \\\n  --set pilot.env.ENABLE_GATEWAY_API_INFERENCE_EXTENSION="true" \\\n  --set tag=$TAG \\\n  --set hub=$HUB \\\n  --wait\n'})}),"\n",(0,i.jsx)(n.p,{children:"Then, create the Gateway resource that will handle incoming requests and integrate with GWIE per the example configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f github.com/kaito-project/kaito/blob/main/examples/gateway-api-inference-extension/gateway.yaml\n"})}),"\n",(0,i.jsx)(n.h3,{id:"2-deploy-kaito-workspace",children:"2. Deploy KAITO Workspace"}),"\n",(0,i.jsx)(n.p,{children:"Create a sample KAITO Workspace (using a vLLM preset) that will host the model server behind the inference gateway:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f github.com/kaito-project/kaito/blob/main/examples/inference/kaito_workspace_phi_4_mini.yaml\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-deploy-destinationrule-and-httproute",children:"3. Deploy DestinationRule and HTTPRoute"}),"\n",(0,i.jsxs)(n.p,{children:["Apply an Istio DestinationRule. Since EPP runs with ",(0,i.jsx)(n.code,{children:"--secure-serving=true"})," by default using a self-signed certificate, and Istio doesn't trust self-signed certificates, this DestinationRule bypasses TLS verification as a temporary workaround:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f github.com/kaito-project/kaito/blob/main/examples/gateway-api-inference-extension/destinationrule-phi-4-mini-instruct.yaml\n"})}),"\n",(0,i.jsx)(n.p,{children:"Create the HTTPRoute that targets the Workspace\u2019s InferencePool (via ExtensionRef) and defines the routing matchers used by the gateway:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f github.com/kaito-project/kaito/blob/main/examples/gateway-api-inference-extension/httproute.yaml\n"})}),"\n",(0,i.jsx)(n.h3,{id:"4-test-inference",children:"4. Test Inference"}),"\n",(0,i.jsx)(n.p,{children:"Verify that the InferencePool is properly configured and ready to accept traffic by checking its status conditions:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl describe inferencepool workspace-phi-4-mini-inferencepool\n\n...\n    Conditions:\n      Last Transition Time:  2025-08-26T18:55:13Z\n      Message:               Referenced by an HTTPRoute accepted by the parentRef Gateway\n      Observed Generation:   1\n      Reason:                Accepted\n      Status:                True\n      Type:                  Accepted\n      Last Transition Time:  2025-08-26T18:55:13Z\n      Message:               Referenced ExtensionRef resolved successfully\n      Observed Generation:   1\n      Reason:                ResolvedRefs\n      Status:                True\n      Type:                  ResolvedRefs\n...\n"})}),"\n",(0,i.jsx)(n.p,{children:"Get the ClusterIP of the Istio Gateway service to enable internal cluster routing:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl get service\n\nNAME                      TYPE           CLUSTER-IP     EXTERNAL-IP     PORT(S)                        AGE\ninference-gateway-istio   LoadBalancer   10.0.249.124                   15021:31583/TCP,80:30314/TCP   13m\n"})}),"\n",(0,i.jsx)(n.p,{children:"Export the ClusterIP for easy access and test the inference endpoint using a temporary curl pod:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'export CLUSTERIP=$(kubectl get svc inference-gateway-istio -o jsonpath=\'{.spec.clusterIP}\')\nkubectl run -it --rm --restart=Never curl --image=curlimages/curl -- curl -s  http://$CLUSTERIP/v1/models | jq\n\n{\n  "data": [\n    {\n      "created": 1756234889,\n      "id": "phi-4-mini-instruct",\n      "max_model_len": 131072,\n      "object": "model",\n      "owned_by": "vllm",\n      "parent": null,\n      "permission": [\n        {\n          "allow_create_engine": false,\n          "allow_fine_tuning": false,\n          "allow_logprobs": true,\n          "allow_sampling": true,\n          "allow_search_indices": false,\n          "allow_view": true,\n          "created": 1756234889,\n          "group": null,\n          "id": "modelperm-de0d47575adf467f8222aac90296aab8",\n          "is_blocking": false,\n          "object": "model_permission",\n          "organization": "*"\n        }\n      ],\n      "root": "/workspace/vllm/weights"\n    }\n  ],\n  "object": "list"\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Send a chat completion request to test the inference endpoint:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'kubectl run -it --rm --restart=Never curl --image=curlimages/curl -- curl -X POST http://$CLUSTERIP/v1/chat/completions \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "model": "phi-4-mini-instruct",\n    "messages": [{"role": "user", "content": "What is kubernetes?"}],\n    "max_tokens": 50\n  }\' | jq\n\n{\n  "choices": [\n    {\n      "finish_reason": "length",\n      "index": 0,\n      "logprobs": null,\n      "message": {\n        "annotations": null,\n        "audio": null,\n        "content": "Kubernetes, often abbreviated as K8s, is an open-source platform designed to automate the deployment, scaling, and operation of application containers. It was originally developed by Google and is now maintained by the Cloud Native Computing Foundation (CNCF).",\n        "function_call": null,\n        "reasoning_content": null,\n        "refusal": null,\n        "role": "assistant",\n        "tool_calls": []\n      },\n      "stop_reason": null\n    }\n  ],\n  "created": 1756235005,\n  "id": "chatcmpl-e0a390b5-3066-4c4c-8087-80528bb5d843",\n  "kv_transfer_params": null,\n  "model": "phi-4-mini-instruct",\n  "object": "chat.completion",\n  "prompt_logprobs": null,\n  "service_tier": null,\n  "system_fingerprint": null,\n  "usage": {\n    "completion_tokens": 50,\n    "prompt_tokens": 17,\n    "prompt_tokens_details": null,\n    "total_tokens": 67\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"4-optional-deploy-bbr",children:"4. [Optional] Deploy BBR"}),"\n",(0,i.jsxs)(n.p,{children:["Deploy a second KAITO Workspace and DestinationRule with a different model to demonstrate multi-model routing. This step uses ",(0,i.jsx)(n.a,{href:"https://github.com/kaito-project/kaito/blob/main/examples/inference/kaito_workspace_mistral_7b-instruct.yaml",children:(0,i.jsx)(n.code,{children:"mistral-7b-instruct"})})," as an example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f github.com/kaito-project/kaito/blob/main/examples/inference/kaito_workspace_mistral_7b-instruct.yaml\nkubectl apply -f github.com/kaito-project/kaito/blob/main/examples/gateway-api-inference-extension/destinationrule-mistral-7b-instruct.yaml\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Install the Body-Based Routing (BBR) Helm chart. BBR automatically extracts model names from OpenAI-style API requests and injects an ",(0,i.jsx)(n.code,{children:"X-Gateway-Model-Name"})," header to the inference request, enabling model routing without modifying client code:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"helm upgrade --install body-based-router oci://registry.k8s.io/gateway-api-inference-extension/charts/body-based-routing \\\n  --version v0.5.1 \\\n  --set provider.name=istio \\\n  --wait\n"})}),"\n",(0,i.jsx)(n.p,{children:"Update the HTTPRoute to use header-based matching so requests are routed by the model name found in the request body:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f github.com/kaito-project/kaito/blob/main/examples/gateway-api-inference-extension/httproute-bbr.yaml\n"})}),"\n",(0,i.jsx)(n.p,{children:"Verify routing with the original model name; the gateway should route to the corresponding Workspace via the InferencePool:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'kubectl run -it --rm --restart=Never curl --image=curlimages/curl -- curl -X POST http://$CLUSTERIP/v1/chat/completions \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "model": "phi-4-mini-instruct",\n    "messages": [{"role": "user", "content": "What is kubernetes?"}],\n    "max_tokens": 50\n  }\' | jq\n\n{\n  "choices": [\n    {\n      "finish_reason": "length",\n      "index": 0,\n      "logprobs": null,\n      "message": {\n        "annotations": null,\n        "audio": null,\n        "content": "Kubernetes, often abbreviated as K8s, is an open-source container orchestration platform designed to automate the deployment, scaling, and management of containerized applications. It was originally developed by Google and is now maintained by the Cloud Native Computing Foundation (",\n        "function_call": null,\n        "reasoning_content": null,\n        "refusal": null,\n        "role": "assistant",\n        "tool_calls": []\n      },\n      "stop_reason": null\n    }\n  ],\n  "created": 1756237522,\n  "id": "chatcmpl-c7aeedbd-50d1-4ac3-9005-ad8dba451e65",\n  "kv_transfer_params": null,\n  "model": "phi-4-mini-instruct",\n  "object": "chat.completion",\n  "prompt_logprobs": null,\n  "service_tier": null,\n  "system_fingerprint": null,\n  "usage": {\n    "completion_tokens": 50,\n    "prompt_tokens": 17,\n    "prompt_tokens_details": null,\n    "total_tokens": 67\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Now, send the same request but change the model name to ",(0,i.jsx)(n.code,{children:"mistral-7b-instruct"})," to verify BBR-driven model-aware routing across multiple Workspaces:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'kubectl run -it --rm --restart=Never curl --image=curlimages/curl -- curl -X POST http://$CLUSTERIP/v1/chat/completions \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "model": "mistral-7b-instruct",\n    "messages": [{"role": "user", "content": "What is kubernetes?"}],\n    "max_tokens": 50\n  }\' | jq\n\n{\n  "choices": [\n    {\n      "finish_reason": "length",\n      "index": 0,\n      "logprobs": null,\n      "message": {\n        "annotations": null,\n        "audio": null,\n        "content": " Kubernetes (also known as K8s) is an open-source platform designed to automate deployment, scaling, and management of containerized applications. It groups containers that make up an application into logical units for easy management, and helps to ensure",\n        "function_call": null,\n        "reasoning_content": null,\n        "refusal": null,\n        "role": "assistant",\n        "tool_calls": []\n      },\n      "stop_reason": null\n    }\n  ],\n  "created": 1756237560,\n  "id": "chatcmpl-b563a6a5-8009-43e9-aedc-4f4238d8c6b8",\n  "kv_transfer_params": null,\n  "model": "mistral-7b-instruct",\n  "object": "chat.completion",\n  "prompt_logprobs": null,\n  "service_tier": null,\n  "system_fingerprint": null,\n  "usage": {\n    "completion_tokens": 50,\n    "prompt_tokens": 8,\n    "prompt_tokens_details": null,\n    "total_tokens": 58\n  }\n}\n'})})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var a=t(6540);const i={},s=a.createContext(i);function o(e){const n=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);