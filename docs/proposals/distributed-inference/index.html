<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-proposals/distributed-inference" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">Distributed Inference | Kaito</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kaito-project.github.io/kaito/docs/img/kaito-logo.png"><meta data-rh="true" name="twitter:image" content="https://kaito-project.github.io/kaito/docs/img/kaito-logo.png"><meta data-rh="true" property="og:url" content="https://kaito-project.github.io/kaito/docs/proposals/distributed-inference"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Distributed Inference | Kaito"><meta data-rh="true" name="description" content="Distributed Inference"><meta data-rh="true" property="og:description" content="Distributed Inference"><link data-rh="true" rel="icon" href="/kaito/docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kaito-project.github.io/kaito/docs/proposals/distributed-inference"><link data-rh="true" rel="alternate" href="https://kaito-project.github.io/kaito/docs/proposals/distributed-inference" hreflang="en"><link data-rh="true" rel="alternate" href="https://kaito-project.github.io/kaito/docs/proposals/distributed-inference" hreflang="x-default"><link rel="stylesheet" href="/kaito/docs/assets/css/styles.e95ed9fd.css">
<script src="/kaito/docs/assets/js/runtime~main.d11c6b49.js" defer="defer"></script>
<script src="/kaito/docs/assets/js/main.2821cbd7.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️ If you like Kaito, please give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/kaito-project/kaito">GitHub</a>!</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/kaito/docs/"><div class="navbar__logo"><img src="/kaito/docs/img/kaito-logo.png" alt="Kaito Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/kaito/docs/img/kaito-logo.png" alt="Kaito Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Kaito</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kaito-project/kaito" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Title</h1>
<p>Distributed Inference</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p>While KAITO excels with single-GPU models, the increasing size of state-of-the-art models necessitates multi-node distributed inference capabilities. Models with hundreds of billions of parameters often exceed the memory capacity of even the largest single nodes available today.</p>
<p>The default vLLM runtime lacks multi-node support within KAITO since its adoption in January 2025 (<a href="https://github.com/kaito-project/kaito/pull/823" target="_blank" rel="noopener noreferrer">#823</a>). This proposal aims to bridge this gap by implementing multi-node distributed inference, primarily focusing on the vLLM runtime. The goal is to enable  deployment of very large preset models across multiple nodes, ensuring KAITO remains capable of serving cutting-edge models while maintaining a consistent user experience.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-distributed-inference-anyway">What Is Distributed Inference Anyway?<a href="#what-is-distributed-inference-anyway" class="hash-link" aria-label="Direct link to What Is Distributed Inference Anyway?" title="Direct link to What Is Distributed Inference Anyway?">​</a></h2>
<p>Distributed inference enables models too large for a single GPU to run across multiple GPUs or nodes. Key strategies relevant to KAITO include:</p>
<ol>
<li><strong>Single-Node Multi-GPU (Tensor Parallelism):</strong> Splits a model across multiple GPUs <em>within</em> a single node. Used when a model fits on one node but exceeds a single GPU&#x27;s memory. Both HuggingFace Transformers and vLLM support this.</li>
<li><strong>Multi-Node Multi-GPU (Pipeline and Tensor Parallelism):</strong> Splits a model across multiple nodes, typically using pipeline parallelism between nodes and tensor parallelism within each node. Used for models exceeding a single node&#x27;s capacity. HuggingFace Transformers supports this via Torch Elastic, but vLLM currently does not in KAITO.</li>
</ol>
<p>KAITO&#x27;s current support for these strategies:</p>
<table><thead><tr><th>Strategy</th><th style="text-align:center">vLLM</th></tr></thead><tbody><tr><td>Single GPU</td><td style="text-align:center">Yes</td></tr><tr><td>Single-Node Multi-GPU</td><td style="text-align:center">Yes</td></tr><tr><td>Multi-Node Multi-GPU</td><td style="text-align:center">No (This proposal)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals">​</a></h3>
<ul>
<li>Implement multi-node distributed inference for preset models using the vLLM inference runtime in KAITO.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="non-goals">Non-Goals<a href="#non-goals" class="hash-link" aria-label="Direct link to Non-Goals" title="Direct link to Non-Goals">​</a></h3>
<ul>
<li><strong>Applying distributed inference to all preset models:</strong> This proposal specifically targets very large models (e.g., 400B+ parameters) that necessitate multi-node deployment. Applying it to smaller models is not intended, as it could introduce unnecessary overhead and potentially degrade performance.</li>
<li><strong>Supporting distributed inference for custom models:</strong> Custom models currently use Kubernetes Deployments, which lack the stable pod identity required for the proposed multi-node coordination using StatefulSets. Extending support to custom models would require a separate effort.</li>
<li><strong>Implementing distributed model tuning:</strong> The scope of this proposal is limited to inference. Distributed tuning is not addressed.</li>
<li><strong>Introducing new runtimes or deployment mechanisms:</strong> This proposal focuses on enhancing the existing vLLM runtime and StatefulSet deployment strategy, rather than introducing alternatives like LeaderWorkerSet.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="requirements">Requirements<a href="#requirements" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="workspace-api-changes">Workspace API Changes<a href="#workspace-api-changes" class="hash-link" aria-label="Direct link to Workspace API Changes" title="Direct link to Workspace API Changes">​</a></h3>
<p>No API changes are needed for the workspace. The existing workspace API implicitly supports multi-node distributed inference, so users can continue using the same Workspace spec without any changes due to the following:</p>
<ul>
<li>The number of nodes is specified via <code>.resource.count</code> in the Workspace specification:</li>
</ul>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">instanceType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Standard_ND96asr_v4&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For pre-provisioned nodes, users may define a list in the existing API <code>.resource.preferredNodes</code> to ensure inference deployment to specific nodes:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">preferredNodes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">favorite</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">favorite</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul class="contains-task-list containsTaskList_mC6p">
<li class="task-list-item"><input type="checkbox" disabled="" checked=""> <!-- -->For models requiring more than one GPU, validate that <code># GPUs/instance × workspace.resource.count ≥ Required # GPUs for a preset model</code>, and <code>GPU memory * # GPUs ≥ Required model memory</code>. This validation is performed in the API server when creating or updating a workspace. If the condition is not met, an error message will be returned to the user. This is already implemented in <a href="https://github.com/kaito-project/kaito/blob/1815428804593eaa94de0d6f78d82b53e85d0137/api/v1beta1/workspace_validation.go#L293-L380" target="_blank" rel="noopener noreferrer"><code>api/v1beta1/workspace_validation.go</code></a> and does not require any changes.</li>
</ul>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>KAITO respects the user-defined <code>workspace.resource.count</code> and creates exactly that number of nodes in the Workspace through gpu-provisioner. However, based on the chosen instance type, KAITO may deploy the model on fewer nodes than <code>workspace.resource.count</code> if the model can fit in fewer nodes. This behavior is intentional to optimize GPU utilization and reduce overall inter-node communication overhead. Users should be mindful of the cost incurred when specifying a high <code>workspace.resource.count</code> if the model can fit in fewer nodes.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="vllm-runtime-parameters">vLLM Runtime Parameters<a href="#vllm-runtime-parameters" class="hash-link" aria-label="Direct link to vLLM Runtime Parameters" title="Direct link to vLLM Runtime Parameters">​</a></h3>
<p>Flag additions to the vLLM base command is needed to support multi-node distributed inference. Per vLLM&#x27;s <a href="https://docs.vllm.ai/en/latest/serving/distributed_serving.html" target="_blank" rel="noopener noreferrer">guidance</a>:</p>
<ul class="contains-task-list containsTaskList_mC6p">
<li class="task-list-item"><input type="checkbox" disabled="" checked=""> <code>--tensor-parallel-size</code>: Set to the number of GPUs per node to configure tensor parallelism. This parameter determines how the model’s tensors are split across GPUs within a single node.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <code>--pipeline-parallel-size</code>: Set to the number of nodes to configure pipeline parallelism. This parameter determines how different model layers are sharded across nodes.</li>
</ul>
<p>vLLM uses <a href="https://www.ray.io/" target="_blank" rel="noopener noreferrer">Ray</a> as the default framework to manage its distributed inference runtime. vLLM has provided a convenient script called <a href="https://github.com/vllm-project/vllm/blob/main/examples/online_serving/multi-node-serving.sh" target="_blank" rel="noopener noreferrer"><code>multi-node-serving.sh</code></a> to start the Ray server. The same script can be used by worker pods to join the Ray cluster.</p>
<p>Leader:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># --ray_cluster_size is the number of nodes in the cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /workspace/vllm/multi-node-serving.sh leader </span><span class="token parameter variable" style="color:#36acaa">--ray_cluster_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--ray_port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">6379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 8 GPUs per node, 2 nodes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    python3 /workspace/vllm/inference_api.py --tensor-parallel-size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> --pipeline-parallel-size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> --served-model-name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">super-huge-model --kaito-config-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/mnt/config/inference_config.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Workers:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># --ray_address points to the cluster IP of the headless service of the leader pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /workspace/vllm/multi-node-serving.sh worker </span><span class="token parameter variable" style="color:#36acaa">--ray_address</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">http://10.1.2.3:6379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With a StatefulSet, the leader pod can be identified by index <code>0</code> in the pod name (e.g., <code>kaito-vllm-0</code>), and the worker pod index can be identified by their ordinal indices (e.g., <code>kaito-vllm-1</code>, <code>kaito-vllm-2</code>, etc.). The Ray cluster address can be constructed using the headless service of the StatefulSet.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    if [ &quot;${POD_INDEX}&quot; = &quot;0&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      &lt;leader command&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      &lt;worker command&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> POD_INDEX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.labels</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;apps.kubernetes.io/pod-index&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="liveness-and-readiness-probes">Liveness and Readiness Probes<a href="#liveness-and-readiness-probes" class="hash-link" aria-label="Direct link to Liveness and Readiness Probes" title="Direct link to Liveness and Readiness Probes">​</a></h3>
<p>Standard HTTP probes are insufficient for multi-node vLLM, as only the leader pod serves the /health endpoint at port 5000, and Ray cluster dynamics in Kubernetes introduce significant complexities. Key challenges include:</p>
<ul>
<li><strong>Leader Dependency and Initialization</strong>: The leader waits for all n-1 worker pods to join the Ray cluster (where n is the StatefulSet replica count) before starting tasks like model downloading and loading it to GPU memory. If a worker pod fails permanently during initialization or restarts later, the leader does not reinitialize the new worker, rendering the vLLM service unusable until the leader is restarted to recreate the Ray cluster from a clean state.</li>
<li><strong>Worker Rejoining Delay:</strong> In the case of a leader restart, existing worker pods may take 10-30 seconds to rejoin the new Ray cluster.</li>
<li><strong>Ray Actor Health &amp; Count Validation</strong>: The Ray cluster’s health depends on having enough alive actors matching the world size. Dead or missing actors must be detected.</li>
<li><strong>Failure Intolerance</strong>: The current design does not tolerate worker or leader pod failures gracefully. Although leader restart does not require all workers to restart, each worker restart requires a leader restart for synchronization purposes, and sequential node upgrades may incur significant downtime.</li>
</ul>
<p>To address these issues, the following probing strategy is proposed:</p>
<table><thead><tr><th></th><th>Liveness Probe (Triggers Container Restart on Failure)</th><th>Readiness Probe (Does Not Trigger Container Restart on Failure)</th></tr></thead><tbody><tr><td><strong>Leader</strong></td><td>Verifies Ray cluster health by querying the Ray dashboard API for the inference workload&#x27;s job ID and confirming no dead actors associated with that job. If dead actors are found, the probe fails, triggering a container restart to reinitialize the Ray cluster.</td><td>Check <code>$(LEADER_HEADLESS_SVC):$(VLLM_PORT)/health</code>.</td></tr><tr><td><strong>Worker</strong></td><td>vLLM does not gracefully handle worker pod restarts (see <a href="https://github.com/vllm-project/vllm/issues/16259" target="_blank" rel="noopener noreferrer">vLLM #16259</a>), as a restarted worker joins the existing Ray cluster but remains idle, rendering the inference service unusable despite the Ray cluster appearing healthy. That said, implementing a liveness probe for worker pods is unnecessary, as worker health is indirectly validated through the leader’s liveness probe. The leader’s probe, by detecting dead actors, triggers a complete Ray cluster reinitialization, synchronizing both leader and worker pods to restore service functionality.</td><td>Check <code>$(LEADER_HEADLESS_SVC):$(VLLM_PORT)/health</code>.</td></tr></tbody></table>
<p>The following sequential diagram summarizes the expected behavior of the liveness and readiness probes during different failure scenarios:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="leader-pod-crash">Leader Pod Crash<a href="#leader-pod-crash" class="hash-link" aria-label="Direct link to Leader Pod Crash" title="Direct link to Leader Pod Crash">​</a></h4>
<div class="language-mermaid codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mermaid codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sequenceDiagram</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant P as Readiness Probes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant L as Leader Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant W as Worker Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant R as Ray Cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant V as Inference Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    L--xL: Crashes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Note over V: Becomes unavailable (no leader)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    L--xL: Restarts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    P-&gt;&gt;W: Checks /health endpoint from leader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    activate W</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    W-&gt;&gt;P: Fails, marks as not ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deactivate W</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    L-&gt;&gt;R: Recreates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Note over W: May heartbeat to old leader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    W-&gt;&gt;R: Joins new cluster (10-30 seconds delay)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    L-&gt;&gt;R: Waits for all workers to join</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    activate R</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    R-&gt;&gt;L: All workers join</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deactivate R</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Note over L: vLLM Initialization Phase: Model downloading and loading to GPU memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Note over V: Becomes available again</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="worker-pod-crash">Worker Pod Crash<a href="#worker-pod-crash" class="hash-link" aria-label="Direct link to Worker Pod Crash" title="Direct link to Worker Pod Crash">​</a></h4>
<div class="language-mermaid codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mermaid codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sequenceDiagram</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant K as Liveness Probes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant P as Readiness Probes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant L as Leader Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant W as Worker Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant R as Ray Cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant V as Inference Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  W--xW: Crashes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Note over V: Hangs (insufficient workers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P-&gt;&gt;L: Checks /health endpoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  activate L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  L-&gt;&gt;P: Succeeds due to vLLM&#x27;s assumption of all nodes being healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deactivate L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  W--xW: Restarts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  W-&gt;&gt;R: Rejoins but remains idle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Note over V: Continues to hang due to uninitialized worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  K-&gt;&gt;L: Checks for dead Ray actors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  activate L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  L-&gt;&gt;K: Fails, triggers leader container restart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deactivate L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  L--xL: Restarts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  L-&gt;&gt;R: Recreates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Note over W: May heartbeat to old leader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  W-&gt;&gt;R: Joins new cluster (10-30 seconds delay)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  L-&gt;&gt;R: Waits for all workers to join</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  activate R</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  R-&gt;&gt;L: All workers join</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deactivate R</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Note over L,W: vLLM Initialization Phase: Model downloading and loading to GPU memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Note over V: Becomes available again</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="why-restart-the-leader-when-a-worker-crashes-regardless-of-the-state">Why Restart the Leader When a Worker Crashes Regardless of the State?<a href="#why-restart-the-leader-when-a-worker-crashes-regardless-of-the-state" class="hash-link" aria-label="Direct link to Why Restart the Leader When a Worker Crashes Regardless of the State?" title="Direct link to Why Restart the Leader When a Worker Crashes Regardless of the State?">​</a></h4>
<p>Restarting the leader is important for reinitializing the Ray cluster and synchronizing it with any restarted worker pods. This is due to:</p>
<ol>
<li><strong>vLLM&#x27;s Fault Tolerance Assumption</strong>: In a distributed setup, vLLM operates under the assumption that all nodes remain healthy and available (<a href="https://github.com/vllm-project/vllm/blob/d43f914d42dc00a59ca8b6d26363cf02b3b898b2/vllm/executor/ray_distributed_executor.py#L697-L700" target="_blank" rel="noopener noreferrer">source</a>). If a worker pod fails, the leader might not correctly recognize this change in the cluster&#x27;s state, potentially leading to operational inconsistencies.</li>
<li><strong>State Synchronization</strong>: While restarted worker pods might rejoin the existing Ray cluster, they may not share the same operational state as other pods (e.g., model weights loaded into GPU memory). A leader restart ensures that all pods are synchronized and operate with a consistent state.</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="example-configuration">Example Configuration<a href="#example-configuration" class="hash-link" aria-label="Direct link to Example Configuration" title="Direct link to Example Configuration">​</a></h4>
<p>Example configuration for the liveness and readiness probes:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">livenessProbe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">exec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> python3 /workspace/vllm/multi</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">health</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">check.py liveness </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">leader</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">address $(LEADER_HEADLESS_SVC) </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ray</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">port 6379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">initialDelaySeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">periodSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">failThreshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">readinessProbe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">exec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> python3 /workspace/vllm/multi</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">health</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">check.py readiness </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">leader</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">address $(LEADER_HEADLESS_SVC) </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">vllm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">port 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">periodSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The health check script can use the environment variable <code>POD_INDEX</code> to determine if the pod is a leader or worker. The probe should also include an initial delay to the liveness probe to allow time for the leader to initialize the Ray cluster and wait for all worker pods to join. This delay is necessary to avoid false positives during the initial startup phase. Failure thresholds should be set to 1 for liveness probes to ensure that any failure in the leader pod triggers an immediate restart instead of waiting for multiple failures.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="container-image-update">Container Image Update<a href="#container-image-update" class="hash-link" aria-label="Direct link to Container Image Update" title="Direct link to Container Image Update">​</a></h3>
<p>The preset model container images require the following updates:</p>
<ul class="contains-task-list containsTaskList_mC6p">
<li class="task-list-item"><input type="checkbox" disabled=""> <strong>Include Essential Scripts:</strong> Add the <code>multi-node-serving.sh</code> script (sourced from <a href="https://github.com/vllm-project/vllm/blob/main/examples/online_serving/multi-node-serving.sh" target="_blank" rel="noopener noreferrer">vLLM examples</a>) and the custom <code>multi-node-health-check.py</code> script to the Dockerfile. These scripts are necessary for initializing the Ray cluster and performing health checks in a multi-node environment.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <strong>Handle Large Model Weights:</strong> For very large models (e.g., 400B+ parameters), embedding weights directly into the container image is impractical due to size constraints. Leverage existing mechanisms for runtime model weight downloading (<a href="https://github.com/kaito-project/kaito/issues/982" target="_blank" rel="noopener noreferrer">#982</a>) or external weight caching (<a href="https://github.com/kaito-project/kaito/issues/1023" target="_blank" rel="noopener noreferrer">#1023</a>) to manage these large artifacts effectively.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kaito-project/kaito/tree/main/website/docs/proposals/20250325-distributed-inference.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#what-is-distributed-inference-anyway" class="table-of-contents__link toc-highlight">What Is Distributed Inference Anyway?</a><ul><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#non-goals" class="table-of-contents__link toc-highlight">Non-Goals</a></li></ul></li><li><a href="#requirements" class="table-of-contents__link toc-highlight">Requirements</a><ul><li><a href="#workspace-api-changes" class="table-of-contents__link toc-highlight">Workspace API Changes</a></li><li><a href="#vllm-runtime-parameters" class="table-of-contents__link toc-highlight">vLLM Runtime Parameters</a></li><li><a href="#liveness-and-readiness-probes" class="table-of-contents__link toc-highlight">Liveness and Readiness Probes</a></li><li><a href="#container-image-update" class="table-of-contents__link toc-highlight">Container Image Update</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/kaito/docs/">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/kaito/docs/installation">Installation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/kaito-project/kaito" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/kaito-z6a6575/shared_invite/zt-37gh89vw7-odHfqmPRc5oRnDG99SBJNA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Kaito Project, Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>